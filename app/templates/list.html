{% extends "base.html" %}

{% block content %}
  <section class="section">
    <h2 class="section-title">全部音频资源</h2>
    <div class="player-wrapper">
      <audio id="catalog-player" controls preload="none">
        {% if first_audio %}
          <source src="{{ url_for('audio', path=first_audio.relative_path) }}" type="audio/mpeg" />
        {% endif %}
        您的浏览器暂不支持音频播放。
      </audio>
    </div>

    {% if audio_groups %}
      {% for unit, items in audio_groups %}
        <section class="unit-block">
          <h3 class="unit-title">Unit {{ unit }}</h3>
          <div class="audio-grid">
            {% for audio in items %}
              <button class="audio-tile" 
                data-src="audio/{{ audio.relative_path | urlencode }}"
                data-name="{{ audio.display_name }}">
                {{ audio.display_name }}(p{{ audio.page_display }})
              </button>
            {% endfor %}
          </div>
        </section>
      {% endfor %}
    {% else %}
      <p class="empty">暂未收录音频资源。</p>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const catalogPlayer = document.getElementById('catalog-player');
    const catalogTiles = document.querySelectorAll('.audio-tile');
    catalogTiles.forEach((tile) => {
      tile.addEventListener('click', () => {
        const src = tile.dataset.src;
        const name = tile.dataset.name || tile.textContent.trim();
        if (!src) return;

        const isSame = catalogPlayer.currentSrc && catalogPlayer.currentSrc.endsWith(src);
        if (isSame) {
          if (catalogPlayer.paused) catalogPlayer.play(); else catalogPlayer.pause();
        } else {
          catalogPlayer.src = src;
          catalogPlayer.play();
          catalogTiles.forEach((btn) => btn.classList.toggle('active', btn === tile));
          umami.track ('player-start', { src: src, name: name });
          rybbit.event('player-start', { src: src, name: name });
        }
      });
    });
  </script>
{% endblock %}

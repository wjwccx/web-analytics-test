{% extends "base.html" %}

{% block content %}
  <section class="section">
    <h2 class="section-title">免费试听</h2>
    <div class="player-wrapper">
      <audio id="primary-player" controls preload="none">
        {% if first_audio %}
          <source src="{{ url_for('audio', path=first_audio.relative_path) }}" type="audio/mpeg" />
        {% endif %}
        您的浏览器暂不支持音频播放。
      </audio>
    </div>
    <div class="audio-grid">
      {% if featured_audio %}
        {% for audio in featured_audio %}
          <button class="audio-tile" 
            data-src="audio/{{ audio.relative_path | urlencode }}"
            data-name="{{ audio.display_name }}">
            {{ audio.display_name }}(p{{ audio.page_display }})
          </button>
        {% endfor %}
      {% else %}
        <p class="empty">暂未找到可播放的音频文件。</p>
      {% endif %}
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">购买全部音频</h2>
    <form class="order-form" action="{{ url_for('payment') }}" method="post" data-track-event="payment" >
      <div class="form-row">
        <label for="customer_name">联系人</label>
        <input type="text" id="customer_name" name="customer_name" placeholder="选填" />
      </div>
      <div class="form-row">
        <label for="email">邮箱</label>
        <input type="email" id="email" name="email" placeholder="选填" />
      </div>
      <div class="form-row">
        <label for="currency">货币币种</label>
        <select id="currency" name="currency" required>
          {% for code, label in currency_options %}
            <option value="{{ code }}"{% if code == 'USD' %} selected{% endif %}>{{ code }} — {{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label for="revenue">金额</label>
        <div class="input-prefix">
          <input type="number" id="revenue" name="revenue" min="0" step="0.01" placeholder="例如 19.99" required />
        </div>
      </div>
      <div class="form-row">
        <label for="notes">备注</label>
        <textarea id="notes" name="notes" rows="3" placeholder="选填"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="primary">提交订单</button>
      </div>
    </form>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const player = document.getElementById('primary-player');
    const tiles = document.querySelectorAll('.audio-tile');
    tiles.forEach((tile) => {
      tile.addEventListener('click', () => {
        const src = tile.dataset.src;
        const name = tile.dataset.name || tile.textContent.trim();
        if (!src) return;

        const isSame = player.currentSrc && player.currentSrc.endsWith(src);
        if (isSame) {
          if (player.paused) player.play(); else player.pause();
        } else {
          player.src = src;
          player.play();
          tiles.forEach((btn) => btn.classList.toggle('active', btn === tile));
          umami.track ('free-player-start', { src: src, name: name });
          rybbit.event('free-player-start', { src: src, name: name });
        }
      });
    });

  </script>
  <script src="/static/submit-with-track.js"></script>
{% endblock %}
